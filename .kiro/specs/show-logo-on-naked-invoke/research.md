# 調査および設計決定ログ

---
**目的**: 技術設計の根拠となる、発見事項、アーキテクチャ調査、および論理的根拠を記録します。
---

## 概要
- **フィーチャー**: `show-logo-on-naked-invoke`
- **ディスカバリースコープ**: シンプルな追加
- **主要な発見事項**:
  - `typer`の`@app.callback()`デコレータが、コマンド処理前にロジックを注入するための最適なエントリポイントである。
  - `typer.Context`オブジェクトの`invoked_subcommand`属性を利用することで、サブコマンドが呼び出されていない「ネイキッド呼び出し」状態を確実に検出できる。
  - `rich`ライブラリが既にプロジェクトに導入されており、ターミナルへのスタイリングされた出力に適している。
  - CLIのバージョン情報は`pyproject.toml`に定義されており、`typer.Typer`の`version`引数を通じてCLIアプリケーションに統合できる。

## 調査ログ

### トピック: ネイキッド呼び出しの検出方法
- **コンテキスト**: サブコマンドなしでCLIが実行されたことを特定する必要があった。
- **調査したソース**: `typer`の公式ドキュメント。
- **発見事項**: `@app.callback()`で装飾された関数に`ctx: typer.Context`引数を追加することで、コンテキストオブジェクトにアクセスできる。`ctx.invoked_subcommand`が`None`の場合、サブコマンドは呼び出されていない。
- **影響**: このアプローチにより、ロゴ表示ロジックを他のコマンドから分離し、意図した通りのタイミングで確実に実行できる。

### トピック: CLIバージョン情報の取得と表示
- **コンテキスト**: ロゴ表示後にCLIのバージョンを表示する必要がある (要求事項4)。
- **調査したソース**: `pyproject.toml`ファイル、`typer`のドキュメント。
- **発見事項**:
    - プロジェクトのバージョンは`pyproject.toml`の`[project].version`キーで定義されている (`0.1.0`)。
    - `typer.Typer(..., version="0.1.0")`のように`version`引数を渡すことで、`app.info.version`を通じてバージョン情報にアクセスできる。
- **影響**:
    - `cli.py`の`typer.Typer`インスタンスの初期化時にバージョン情報を渡す必要がある。
    - `modaryn/outputs/logo.py`内の表示関数で`app.info.version`を取得し、ロゴの下に表示するロジックを追加する必要がある。

## 設計決定

### 決定: `typer.Context`を使用したロジック分岐
- **コンテキスト**: 要求事項1.1および1.2（引数なしの場合のみロゴを表示）を満たすための堅牢な方法が必要だった。
- **検討した代替案**:
  1. `sys.argv`を直接パースする - `typer`の抽象化を壊すため、脆弱でメンテナンス性が低い。
- **選択したアプローチ**: `main`コールバック関数で`typer.Context`を受け取り、`if ctx.invoked_subcommand is None:`の条件分岐でロゴ表示ロジックを呼び出す。
- **論理的根拠**: `typer`フレームワークの標準的な方法であり、クリーンで意図が明確になる。
- **トレードオフ**: 特になし。これはフレームワークが意図した利用方法である。

### 決定: Typerのバージョン管理機能の利用
- **コンテキスト**: 要求事項4（CLIバージョンの表示）を満たすため、バージョン情報をアプリケーションに統合する必要がある。
- **検討した代替案**:
  1. `pyproject.toml`を直接パースしてバージョンを取得する。
  2. `modaryn/__init__.py`にバージョンをハードコードする。
- **選択したアプローチ**: `typer.Typer(..., version="0.1.0")`のように`app`オブジェクトにバージョン情報を渡す。`modaryn/outputs/logo.py`の表示関数内で`typer.main.get_app().info.version`を呼び出すことでバージョン情報を取得する。
- **論理的根拠**: `typer`の組み込み機能を利用することで、バージョン管理が一貫し、`--version`オプションなどの標準的な機能との整合性が保たれる。
- **トレードオフ**: `pyproject.toml`のバージョン更新時に`cli.py`も更新する必要があるが、これは手動で管理可能な範囲である。
